# SPDX-License-Identifier: GPL-2.0+
# Copyright (C) 2019 Texas Instruments Incorporated - http://www.ti.com/

# build Linux Kernel on Travis CI - https://travis-ci.org/
# Abstracted from uBoot travis.yml (Why reinvent the wheel?)

language: c
sudo: required
dist: trusty

addons:
  apt:
    sources:
    - ubuntu-toolchain-r-test
    - llvm-toolchain-trusty-7
    packages:
    - bison
    - flex
    - cppcheck
    - sparse
    - bc
    - swig
    - device-tree-compiler
    - lzop
    - liblz4-tool
    - lzma-alone
    - libisl15
    - spatch

install:
  - sudo apt-get update -qq
  - git clone --depth=1 https://github.com/nmenon/kernel_patch_verify.git /tmp/kernel-test-hooks
  - mkdir -p toolchain
  - cd toolchain
  - wget https://developer.arm.com/-/media/Files/downloads/gnu-a/8.3-2019.03/binrel/gcc-arm-8.3-2019.03-x86_64-arm-linux-gnueabihf.tar.xz
  - wget https://developer.arm.com/-/media/Files/downloads/gnu-a/8.3-2019.03/binrel/gcc-arm-8.3-2019.03-x86_64-aarch64-linux-gnu.tar.xz
  - tar xf gcc-arm-8.3-2019.03-x86_64-arm-linux-gnueabihf.tar.xz
  - tar xf gcc-arm-8.3-2019.03-x86_64-aarch64-linux-gnu.tar.xz
  - cd ..
  - export PATH=$PATH:$PWD/toolchain/gcc-arm-8.3-2019.03-x86_64-arm-linux-gnueabihf/bin/
  - export PATH=$PATH:$PWD/toolchain/gcc-arm-8.3-2019.03-x86_64-aarch64-linux-gnu/bin/
  - arm-linux-gnueabihf-gcc --version
  - aarch64-linux-gnu-gcc --version

env:
  - export EXTRA_FLAGS="CONFIG_COMPLIE_TEST=y CONFIG_DEBUG_SECTION_MISMATCH=y C=2 CHECK="scripts/coccicheck" MODE=report"

before_script:

script:
  # exporting the variable to be used by make utility  
  - export BUILD_THREADS=$(grep "^processor" /proc/cpuinfo | wc -l)
  - echo $BUILD_THREADS
  - export ARCH=arm64
  - export CROSS_COMPILE=aarch64-linux-gnu-
  - make -j4 defconfig 2>&1
  - make -j4 ${EXTRA_FLAGS} drivers/gpu/drm/bridge/ 2>&1
  - make -j4 ${EXTRA_FLAGS} drivers/phy/ti/ 2>&1
  - make -j4 ${EXTRA_FLAGS} drivers/phy/cadence/ 2>&1
  - make -j4 ${EXTRA_FLAGS} drivers/usb/ 2>&1
#  - make -j4 distclean
#  - export ARCH=arm
#  - export CROSS_COMPILE=arm-linux-gnueabihf-
#  - make -j4 multi_v7_defconfig 2>&1
#  - make -j4 ${EXTRA_FLAGS} 2>&1

