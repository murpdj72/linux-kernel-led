# SPDX-License-Identifier: GPL-2.0+
# Copyright (C) 2019 Texas Instruments Incorporated - http://www.ti.com/

# build Linux Kernel on Travis CI - https://travis-ci.org/
# Abstracted from uBoot travis.yml (Why reinvent the wheel?)

language: c
sudo: required
dist: trusty

addons:
  apt:
    sources:
    - ubuntu-toolchain-r-test
    - llvm-toolchain-trusty-7
    packages:
    - bison
    - flex
    - cppcheck
    - sparse
    - bc
    - swig
    - device-tree-compiler
    - lzop
    - liblz4-tool
    - lzma-alone
    - libisl15
    - libelf-dev

install:
  - sudo apt-get update -qq

env:
  - export EXTRA_FLAGS="CONFIG_COMPLIE_TEST=y CONFIG_DEBUG_SECTION_MISMATCH=y"

before_script:
  - mkdir -p toolchain
  - cd toolchain
  - echo ${EXTRA_FLAGS}
  - if [[ "${TOOLCHAIN}" == arm ]]; then
     wget https://developer.arm.com/-/media/Files/downloads/gnu-a/8.3-2019.03/binrel/gcc-arm-8.3-2019.03-x86_64-arm-linux-gnueabihf.tar.xz &&
     tar xf gcc-arm-8.3-2019.03-x86_64-arm-linux-gnueabihf.tar.xz;
   fi
  - if [[ "${TOOLCHAIN}" == arm64 ]]; then
      wget https://developer.arm.com/-/media/Files/downloads/gnu-a/8.3-2019.03/binrel/gcc-arm-8.3-2019.03-x86_64-aarch64-linux-gnu.tar.xz &&
      tar xf gcc-arm-8.3-2019.03-x86_64-aarch64-linux-gnu.tar.xz;
    fi
  - if [[ "${TOOLCHAIN}" == x86_64 ]]; then
      wget https://mirrors.edge.kernel.org/pub/tools/crosstool/files/bin/x86_64/8.1.0/x86_64-gcc-8.1.0-nolibc-x86_64-linux.tar.gz &&
      tar xf x86_64-gcc-8.1.0-nolibc-x86_64-linux.tar.gz;
    fi
  - cd ..

script:
  # exporting the variable to be used by make utility  
  - export BUILD_THREADS=$(grep "^processor" /proc/cpuinfo | wc -l)
  - pwd
  - if [[ "${TOOLCHAIN}" == arm64 ]]; then
     export ARCH=arm64;
     export CROSS_COMPILE=$PWD/toolchain/gcc-arm-8.3-2019.03-x86_64-aarch64-linux-gnu/bin/aarch64-linux-gnu-;
     make -j4 defconfig 2>&1;
     make -j16 ${EXTRA_FLAGS} 2>&1;
    fi
  - if [[ "${TOOLCHAIN}" == arm ]]; then
     export ARCH=arm &&
     export CROSS_COMPILE=$PWD/toolchain/gcc-arm-8.3-2019.03-x86_64-arm-linux-gnueabihf/bin/arm-linux-gnueabihf- &&
     make -j4 multi_v7_defconfig 2>&1 &&
     make -j8 ${EXTRA_FLAGS} 2>&1;
    fi
  - if [[ "${TOOLCHAIN}" == x86_64 ]]; then
     export CROSS_COMPILE=$PWD/toolchain/gcc-8.1.0-nolibc/x86_64-linux/bin/x86_64-linux- &&
     make -j4 x86_64_defconfig 2>&1 &&
     make -j8 ${EXTRA_FLAGS} 2>&1;
    fi

matrix:
  include:
  # we need to build by vendor due to 50min time limit for builds
  # each env setting here is a dedicated build
    - name: "buildman arm"
      env:
        - BUILDMAN="arm"
          TOOLCHAIN="arm"
    - name: "buildman arm64"
      env:
        - BUILDMAN="arm64"
          TOOLCHAIN="arm64"
    - name: "buildman x86_64"
      env:
        - BUILDMAN="x86_64"
          TOOLCHAIN="x86_64"

